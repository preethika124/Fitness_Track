<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register - Smart Health</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>

<div class="container">

    <div class="header">
        <div class="logo">SH</div>
        <div>
            <h1>Create account</h1>
            <p class="sub">Register to start your fitness journey</p>
        </div>
    </div>

    <!-- FIRST NAME -->
    <input id="firstName" type="text" placeholder="First name">
    <div id="errFirst" class="error-msg"></div>

    <!-- LAST NAME -->
    <input id="lastName" type="text" placeholder="Last name">
    <div id="errLast" class="error-msg"></div>

    <!-- EMAIL -->
    <input id="email" type="email" placeholder="Email">
    <div id="errEmail" class="error-msg"></div>

    <!-- PASSWORD WITH SHOW/HIDE -->
    <div class="password-wrapper">
        <input id="password" type="password" placeholder="Password">
        <span class="toggle-eye" id="toggleEye">üëÅ</span>
    </div>
    <div id="errPass" class="error-msg"></div>

    <!-- CONFIRM PASSWORD -->
    <div class="password-wrapper">
        <input id="confirmPassword" type="password" placeholder="Confirm Password">
        <span class="toggle-eye" id="toggleEyeConfirm">üëÅ</span>
    </div>
    <div id="errConfirm" class="error-msg"></div>

    <!-- ROLE DROPDOWN -->
    <div class="dropdown" id="roleDropdown">
        <div class="dropdown-selected" id="dropdownSelected">User</div>
        <div class="dropdown-menu" id="dropdownMenu">
            <div class="dropdown-item">User</div>
            <div class="dropdown-item">Trainer</div>
        </div>
    </div>

    <button class="primary" id="registerBtn">Create Account</button>
    <button class="btn-ghost" id="toLogin">Back to Login</button>
</div>


<script>
document.addEventListener("DOMContentLoaded", () => {

    console.log("REGISTER.JS READY");

    // -------------------------
    // STRONG PASSWORD CHECKER
    // -------------------------
    function isStrongPassword(password) {
        const minLength = /.{8,}/;
        const upper = /[A-Z]/;
        const lower = /[a-z]/;
        const number = /[0-9]/;
        const special = /[!@#$%^&*(),.?":{}|<>]/;

        return (
            minLength.test(password) &&
            upper.test(password) &&
            lower.test(password) &&
            number.test(password) &&
            special.test(password)
        );
    }

    /* -------------------------
       DROPDOWN HANDLING
    -------------------------- */
    const selected = document.getElementById("dropdownSelected");
    const menu = document.getElementById("dropdownMenu");

    selected.onclick = () => {
        menu.style.display = menu.style.display === "block" ? "none" : "block";
    };

    document.querySelectorAll(".dropdown-item").forEach(item => {
        item.onclick = () => {
            selected.textContent = item.textContent;
            menu.style.display = "none";
        };
    });

    document.addEventListener("click", e => {
        if (!document.getElementById("roleDropdown").contains(e.target)) {
            menu.style.display = "none";
        }
    });

    /* -------------------------
       PASSWORD SHOW/HIDE
    -------------------------- */
    const pass = document.getElementById("password");
    const toggle = document.getElementById("toggleEye");

    toggle.onclick = () => {
        if (pass.type === "password") {
            pass.type = "text";
            toggle.textContent = "üôà";
        } else {
            pass.type = "password";
            toggle.textContent = "üëÅ";
        }
    };

    // -------------------------
    // CONFIRM PASSWORD SHOW/HIDE
    // -------------------------
    const confirmInput = document.getElementById("confirmPassword");
    const toggleConfirm = document.getElementById("toggleEyeConfirm");

    toggleConfirm.onclick = () => {
        if (confirmInput.type === "password") {
            confirmInput.type = "text";
            toggleConfirm.textContent = "üôà";
        } else {
            confirmInput.type = "password";
            toggleConfirm.textContent = "üëÅ";
        }
    };

    /* -------------------------
       REGISTER BUTTON HANDLING
    -------------------------- */
    document.getElementById("toLogin").onclick = () =>
        location.href = "login.html";

    document.getElementById("registerBtn").onclick = async () => {
        console.log("REGISTER BUTTON CLICKED");

        const firstName = document.getElementById("firstName").value.trim();
        const lastName  = document.getElementById("lastName").value.trim();
        const email     = document.getElementById("email").value.trim();
        const password  = document.getElementById("password").value.trim();
        const confirmPassword = document.getElementById("confirmPassword").value.trim();
        const role = selected.textContent.trim().toUpperCase();

        // Clear old errors
        document.querySelectorAll(".error-msg").forEach(e => e.textContent = "");

        let ok = true;
        if (!firstName) { errFirst.textContent = "First name required"; ok = false; }
        if (!lastName)  { errLast.textContent = "Last name required"; ok = false; }
        if (!email)     { errEmail.textContent = "Email required"; ok = false; }

        // -------------------------
        // PASSWORD VALIDATION
        // -------------------------
        if (!password) {
            errPass.textContent = "Password required";
            ok = false;
        }
        else if (!isStrongPassword(password)) {
            errPass.textContent =
                "Weak password. Use 8+ characters with uppercase, lowercase, number & special symbol.";
            ok = false;
        }

        // -------------------------
        // CONFIRM PASSWORD VALIDATION
        // -------------------------
        if (!confirmPassword) {
            errConfirm.textContent = "Please confirm password";
            ok = false;
        }
        else if (password !== confirmPassword) {
            errConfirm.textContent = "Passwords do not match";
            ok = false;
        }

        if (!ok) return; // Do not call API

        try {
            const res = await fetch("/smart-health-track/register", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ firstName, lastName, email, password, role })
            });

            const data = await res.json();
            console.log("REGISTER RESPONSE:", data);

            if (res.status === 201) {
                alert("Account created successfully!");
                location.href = "login.html";
            } else {
                alert(data.error || "Registration failed");
            }

        } catch (err) {
            alert("Network error");
            console.error(err);
        }
    };

}); // END DOMContentLoaded
</script>

</body>
</html>
